<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>myria3d.data.loading &mdash; myria3d 2.3.4 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sphinx_paramlinks.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> myria3d
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/setup_install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/setup_install.html#setting-up-a-virtual-environment">Setting up a virtual environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/setup_install.html#install-source-as-a-package">Install source as a package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/prepare_dataset.html">Preparing data for training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/prepare_dataset.html#using-your-own-data">Using your own data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/prepare_dataset.html#data-preparation">Data preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/prepare_dataset.html#getting-started-quickly-with-a-toy-dataset">Getting started quickly with a toy dataset</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/make_predictions.html">Performing inference on new data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/make_predictions.html#run-inference-from-installed-package">Run inference from installed package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/make_predictions.html#run-inference-from-sources">Run inference from sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/make_predictions.html#run-inference-from-within-a-docker-image">Run inference from within a docker image</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/train_new_model.html">How to train new models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/train_new_model.html#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/train_new_model.html#quick-run">Quick run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/train_new_model.html#training">Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/train_new_model.html#testing-the-model">Testing the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/train_new_model.html#inference">Inference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/development.html">Developerâ€™s guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/development.html#code-versionning">Code versionning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/development.html#tests">Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/development.html#continuous-integration-ci">Continuous Integration (CI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/development.html#continuous-delivery-cd">Continuous Delivery (CD)</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../background/interpolation.html">KNN-Interpolation to merge multiple predictions [TODO]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../background/general_design.html">General design of the package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../background/general_design.html#subsampling-is-important-to-improve-point-cloud-structure">Subsampling is important to improve point cloud structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../background/general_design.html#speed-is-of-the-essence">Speed is of the essence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../background/general_design.html#evaluation-is-key-to-select-the-right-approach">Evaluation is key to select the right approach</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/scripts.html">Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/scripts.html#module-run">run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/scripts.html#module-myria3d.train">myria3d.train</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/scripts.html#module-myria3d.predict">myria3d.predict</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/configs.html">Default configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/myria3d.data.html">myria3d.data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.data.html#module-myria3d.data.datamodule">myria3d.data.datamodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.data.html#module-myria3d.data.loading">myria3d.data.loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.data.html#module-myria3d.data.transforms">myria3d.data.transforms</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/myria3d.model.html">myria3d.models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.model.html#module-myria3d.models.model">Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.model.html#module-myria3d.models.interpolation">Interpolation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/myria3d.models.modules.html">myria3d.models.modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.models.modules.html#pointnet">PointNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.models.modules.html#randla-net">RandLA-Net</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/myria3d.callbacks.html">myria3d.callbacks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.callbacks.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.callbacks.html#module-myria3d.callbacks.comet_callbacks">myria3d.callbacks.comet_callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.callbacks.html#module-myria3d.callbacks.finetuning_callbacks">myria3d.callbacks.finetuning_callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.callbacks.html#module-myria3d.callbacks.logging_callbacks">myria3d.callbacks.logging_callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.callbacks.html#module-myria3d.callbacks">Module contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/myria3d.utils.html">myria3d.utils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/myria3d.utils.html#module-myria3d.utils.utils">myria3d.utils.utils</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">myria3d</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>myria3d.data.loading</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for myria3d.data.loading</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;How to represent points clouds, specifying specific data signatures (e.g. choice of features).</span>

<span class="sd">Country-specific definitions inherit from abstract class LidarDataLogic, which implements general logics</span>
<span class="sd">to split each point cloud into subtiles, format these subtiles, and save a learning-ready dataset splitted into</span>
<span class="sd">train, val. A test set is also created, which is simply a copy of the selected test point clouds. This is so</span>
<span class="sd">test phase conditions are similar to &quot;in-the-wild&quot; prediction conditions.</span>

<span class="sd">In particular, subclasses implement a &quot;load_las&quot; method that is used by the datamodule at test and inference time.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">osp</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copyfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">laspy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch_geometric.data</span> <span class="kn">import</span> <span class="n">Data</span>

<span class="n">SPLIT_PHASES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>

<span class="c1"># Files for the creation of a toy dataset.</span>
<span class="n">LAS_SUBSET_FOR_TOY_DATASET</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;tests/data/toy_dataset_src/870000_6618000.subset.50mx100m.las&quot;</span>
<span class="p">)</span>
<span class="n">SPLIT_CSV_FOR_TOY_DATASET</span> <span class="o">=</span> <span class="s2">&quot;tests/data/toy_dataset_src/toy_dataset_split.csv&quot;</span>


<div class="viewcode-block" id="LidarDataLogic"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.LidarDataLogic">[docs]</a><span class="k">class</span> <span class="nc">LidarDataLogic</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract class to load, chunk, and save a point cloud dataset according to a train/val/test split.</span>
<span class="sd">    load_las and its needed parameters ares specified in child classes.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">return_number_normalization_max_value</span> <span class="o">=</span> <span class="mi">7</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prepared_data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">split_csv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">input_tile_width_meters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">subtile_width_meters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_data_dir</span> <span class="o">=</span> <span class="n">input_data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepared_data_dir</span> <span class="o">=</span> <span class="n">prepared_data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_csv</span> <span class="o">=</span> <span class="n">split_csv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_tile_width_meters</span> <span class="o">=</span> <span class="n">input_tile_width_meters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtile_width_meters</span> <span class="o">=</span> <span class="n">subtile_width_meters</span>

<div class="viewcode-block" id="LidarDataLogic.load_las"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.LidarDataLogic.load_las">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">load_las</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">las_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Data</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load a point cloud in LAS format to memory and turn it into torch-geometric Data object.</span>

<span class="sd">        Args:</span>
<span class="sd">            las_filepath (str): path to the LAS file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Data: The point cloud formatted for later deep learning training.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="LidarDataLogic.prepare"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.LidarDataLogic.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare a dataset for model training and model evaluation.</span>

<span class="sd">        Iterates through LAS files listed in a csv metadata file.</span>
<span class="sd">        A `split` column specifies the train/val/test split of the dataset to be created.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">split_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_csv</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">SPLIT_PHASES</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Phases&quot;</span><span class="p">):</span>
            <span class="n">basenames</span> <span class="o">=</span> <span class="n">split_df</span><span class="p">[</span><span class="n">split_df</span><span class="o">.</span><span class="n">split</span> <span class="o">==</span> <span class="n">phase</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subset: </span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basenames</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">file_basename</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">basenames</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Files&quot;</span><span class="p">):</span>
                <span class="n">las_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_file_in_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data_dir</span><span class="p">,</span> <span class="n">file_basename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                    <span class="c1"># Simply copy the LAS to the new test folder.</span>
                    <span class="n">test_subdir_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepared_data_dir</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_subdir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">copy_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_subdir_path</span><span class="p">,</span> <span class="n">file_basename</span><span class="p">)</span>
                    <span class="n">copyfile</span><span class="p">(</span><span class="n">las_path</span><span class="p">,</span> <span class="n">copy_path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">]:</span>
                    <span class="c1"># Load LAS into memory as a Data object with selected features,</span>
                    <span class="c1"># then iteratively extract 50m*50m subtiles by filtering along x</span>
                    <span class="c1"># then y axis. Serialize the resulting Data object using torch.save.</span>
                    <span class="n">subdir_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prepared_data_dir</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">las_path</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">subdir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">split_and_save</span><span class="p">(</span><span class="n">las_path</span><span class="p">,</span> <span class="n">subdir_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Phase should be one of train/val/test.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LidarDataLogic.split_and_save"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.LidarDataLogic.split_and_save">[docs]</a>    <span class="k">def</span> <span class="nf">split_and_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_subdir_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse a LAS, extract and save each subtile as a Data object.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath (str): input LAS file</span>
<span class="sd">            output_subdir_path (str): output directory to save splitted `.data` objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">range_by_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_tile_width_meters</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtile_width_meters</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_las</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">range_by_axis</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
                <span class="c1"># Ignore if empty</span>
                <span class="k">break</span>
            <span class="n">data_x_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_by_x</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">range_by_axis</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_x_band</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
                    <span class="c1"># Ignore if empty</span>
                    <span class="k">break</span>
                <span class="n">subtile_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_by_y</span><span class="p">(</span><span class="n">data_x_band</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">subtile_data</span> <span class="ow">and</span> <span class="n">subtile_data</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">(</span><span class="n">subtile_data</span><span class="p">,</span> <span class="n">output_subdir_path</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="nf">_find_file_in_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">basename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Query files matching a basename in input_data_dir and its subdirectories.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data_dir (str): data directory</span>

<span class="sd">        Returns:</span>
<span class="sd">            [str]: first file path matching the query.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">input_data_dir</span><span class="si">}</span><span class="s2">/**/</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_extract_by_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Data</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Filter a data object on a chosen axis, using a relative position .</span>
<span class="sd">        Modifies the original data object so that extracted future filters are faster.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Data): a pyg Data object with pos, x, and y attributes.</span>
<span class="sd">            relative_pos (int): where the data to extract start on chosen axis (typically in range 0-1000)</span>
<span class="sd">            axis (int, optional): 0 for x and 1 for y axis. Defaults to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Data: the data that is at most subtile_width_meters above relative_pos on the chosen axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sub_tile_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">pos_axis</span> <span class="o">=</span> <span class="n">sub_tile_data</span><span class="o">.</span><span class="n">pos</span><span class="p">[:,</span> <span class="n">axis</span><span class="p">]</span>
        <span class="n">absolute_low</span> <span class="o">=</span> <span class="n">pos_axis</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">absolute_high</span> <span class="o">=</span> <span class="n">absolute_low</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtile_width_meters</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">absolute_low</span> <span class="o">&lt;=</span> <span class="n">pos_axis</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pos_axis</span> <span class="o">&lt;=</span> <span class="n">absolute_high</span><span class="p">)</span>

        <span class="c1"># select</span>
        <span class="n">sub_tile_data</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">sub_tile_data</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">sub_tile_data</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">sub_tile_data</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">sub_tile_data</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sub_tile_data</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">sub_tile_data</span><span class="o">.</span><span class="n">idx_in_original_cloud</span> <span class="o">=</span> <span class="n">sub_tile_data</span><span class="o">.</span><span class="n">idx_in_original_cloud</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="n">data</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">idx_in_original_cloud</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">idx_in_original_cloud</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sub_tile_data</span>

    <span class="k">def</span> <span class="nf">_extract_by_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Data</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;extract_by_axis applied on first axis x&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_by_axis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_by_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Data</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;extract_by_axis applied on second axis y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_by_axis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtile_data</span><span class="p">:</span> <span class="n">Data</span><span class="p">,</span> <span class="n">output_subdir_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the subtile data object with torch.</span>

<span class="sd">        Args:</span>
<span class="sd">            subtile_data (Data): the object to save.</span>
<span class="sd">            output_subdir_path (str): the subfolder to save it.</span>
<span class="sd">            idx (int): an arbitrary but unique subtile identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subtile_save_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_subdir_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">.data&quot;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">subtile_data</span><span class="p">,</span> <span class="n">subtile_save_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="FrenchLidarDataLogic"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.FrenchLidarDataLogic">[docs]</a><span class="k">class</span> <span class="nc">FrenchLidarDataLogic</span><span class="p">(</span><span class="n">LidarDataLogic</span><span class="p">):</span>

    <span class="n">x_features_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;return_number&quot;</span><span class="p">,</span>
        <span class="s2">&quot;number_of_returns&quot;</span><span class="p">,</span>
        <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rgb_avg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ndvi&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">colors_normalization_max_value</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">*</span> <span class="mi">256</span>

<div class="viewcode-block" id="FrenchLidarDataLogic.load_las"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.FrenchLidarDataLogic.load_las">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_las</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">las_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Loads a point cloud in LAS format to memory and turns it into torch-geometric Data object.</span>

<span class="s2">        Builds a composite (average) color channel on the fly.</span>

<span class="s2">        Calculate NDVI on the fly.</span>

<span class="s2">        x_features_names are </span><span class="si">{</span><span class="s1">&#39; - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        Args:</span>
<span class="s2">            las_filepath (str): path to the LAS file.</span>

<span class="s2">        Returns:</span>
<span class="s2">            Data: the point cloud formatted for later deep learning training.</span>

<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">las</span> <span class="o">=</span> <span class="n">laspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">las_filepath</span><span class="p">)</span>

        <span class="c1"># Positions and base features</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">las</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">las</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">las</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">las</span><span class="p">[</span><span class="n">x_name</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">x_name</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;return_number&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;number_of_returns&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;nir&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="c1"># normalization</span>
        <span class="n">return_number_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;return_number&quot;</span><span class="p">)</span>
        <span class="n">occluded_points</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">return_number_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="n">x</span><span class="p">[:,</span> <span class="n">return_number_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">return_number_idx</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">return_number_normalization_max_value</span>
        <span class="p">)</span>
        <span class="n">num_return_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;number_of_returns&quot;</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[:,</span> <span class="n">num_return_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">num_return_idx</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">return_number_normalization_max_value</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;nir&quot;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="p">)</span>  <span class="c1"># DEBUG: just to be sure that it is the same as before</span>
                <span class="k">assert</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">colors_normalization_max_value</span>
                <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="bp">cls</span><span class="o">.</span><span class="n">colors_normalization_max_value</span>
                <span class="n">x</span><span class="p">[</span><span class="n">occluded_points</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">red</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)]</span>
        <span class="n">green</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;green&quot;</span><span class="p">)]</span>
        <span class="n">blue</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)]</span>

        <span class="c1"># Additional features :</span>
        <span class="c1"># Average color, that will be normalized on the fly based on single-sample</span>
        <span class="n">rgb_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># NDVI</span>
        <span class="n">nir</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">)]</span>
        <span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">red</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">red</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">rgb_avg</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">ndvi</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># for LAS format V1.2</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">classification</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># for  LAS format V1.4</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">classification</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Data</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
            <span class="n">las_filepath</span><span class="o">=</span><span class="n">las_filepath</span><span class="p">,</span>
            <span class="n">x_features_names</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="p">,</span>
            <span class="n">idx_in_original_cloud</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="SwissTopoLidarDataLogic"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.SwissTopoLidarDataLogic">[docs]</a><span class="k">class</span> <span class="nc">SwissTopoLidarDataLogic</span><span class="p">(</span><span class="n">LidarDataLogic</span><span class="p">):</span>
    <span class="n">x_features_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;return_number&quot;</span><span class="p">,</span>
        <span class="s2">&quot;number_of_returns&quot;</span><span class="p">,</span>
        <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rgb_avg&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">colors_normalization_max_value</span> <span class="o">=</span> <span class="mi">256</span>

<div class="viewcode-block" id="SwissTopoLidarDataLogic.load_las"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.SwissTopoLidarDataLogic.load_las">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_las</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">las_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Data</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loads a point cloud in LAS format to memory and turns it into torch-geometric Data object.</span>

<span class="sd">        Builds a composite (average) color channel on the fly.</span>

<span class="sd">        Args:</span>
<span class="sd">            las_filepath (str): path to the LAS file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Data: the point cloud formatted for later deep learning training.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">las</span> <span class="o">=</span> <span class="n">laspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">las_filepath</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">las</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">las</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">las</span><span class="o">.</span><span class="n">z</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">las</span><span class="p">[</span><span class="n">x_name</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">x_name</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;return_number&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;number_of_returns&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;green&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="n">return_number_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;return_number&quot;</span><span class="p">)</span>
        <span class="n">occluded_points</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">return_number_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="n">x</span><span class="p">[:,</span> <span class="n">return_number_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">return_number_idx</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">return_number_normalization_max_value</span>
        <span class="p">)</span>
        <span class="n">num_return_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;number_of_returns&quot;</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[:,</span> <span class="n">num_return_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">num_return_idx</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">return_number_normalization_max_value</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">colors_normalization_max_value</span>
                <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="bp">cls</span><span class="o">.</span><span class="n">colors_normalization_max_value</span>
                <span class="n">x</span><span class="p">[</span><span class="n">occluded_points</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">rgb_avg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="p">[</span><span class="n">las</span><span class="p">[</span><span class="n">x_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">x_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">rgb_avg</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># for LAS format V1.2</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">classification</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># for  LAS format V1.4</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">classification</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Data</span><span class="p">(</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
            <span class="n">las_filepath</span><span class="o">=</span><span class="n">las_filepath</span><span class="p">,</span>
            <span class="n">x_features_names</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">x_features_names</span><span class="p">,</span>
            <span class="n">idx_in_original_cloud</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="make_toy_dataset_from_test_file"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.make_toy_dataset_from_test_file">[docs]</a><span class="k">def</span> <span class="nf">make_toy_dataset_from_test_file</span><span class="p">(</span>
    <span class="n">prepared_data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">src_las_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">LAS_SUBSET_FOR_TOY_DATASET</span><span class="p">,</span>
    <span class="n">split_csv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">SPLIT_CSV_FOR_TOY_DATASET</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare a toy dataset from a single, small LAS file.</span>

<span class="sd">    The file is first duplicated to get 2 LAS in each split (train/val/test),</span>
<span class="sd">    and then each file is splitted into .data files, resulting in a training-ready</span>
<span class="sd">    dataset loacted in td_prepared</span>

<span class="sd">    Args:</span>
<span class="sd">        src_las_path (str): input, small LAS file to generate toy dataset from</span>
<span class="sd">        split_csv (str): Path to csv with a `basename` (e.g. &#39;123_456.las&#39;) and</span>
<span class="sd">        a `split` (train/val/test) columns specifying the dataset split.</span>
<span class="sd">        prepared_data_dir (str): where to copy files (`raw` subfolder) and to prepare</span>
<span class="sd">        dataset files (`prepared` subfolder)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: path to directory containing prepared dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy input file for full test isolation</span>
    <span class="n">td_raw</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prepared_data_dir</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">)</span>
    <span class="n">td_prepared</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prepared_data_dir</span><span class="p">,</span> <span class="s2">&quot;prepared&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">td_raw</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">td_prepared</span><span class="p">)</span>
    <span class="c1"># Make a &quot;raw&quot;, unporcessed dataset with six files.</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src_las_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train1&quot;</span><span class="p">,</span> <span class="s2">&quot;train2&quot;</span><span class="p">,</span> <span class="s2">&quot;val1&quot;</span><span class="p">,</span> <span class="s2">&quot;val2&quot;</span><span class="p">,</span> <span class="s2">&quot;test1&quot;</span><span class="p">,</span> <span class="s2">&quot;test2&quot;</span><span class="p">]:</span>
        <span class="n">copy_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">td_raw</span><span class="p">,</span> <span class="n">basename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.las&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">.las&quot;</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src_las_path</span><span class="p">,</span> <span class="n">copy_path</span><span class="p">)</span>

    <span class="c1"># Prepare a Deep-Learning-ready dataset, using the split defined in the csv.</span>
    <span class="n">data_prepper</span> <span class="o">=</span> <span class="n">FrenchLidarDataLogic</span><span class="p">(</span>
        <span class="n">input_data_dir</span><span class="o">=</span><span class="n">td_raw</span><span class="p">,</span>
        <span class="n">prepared_data_dir</span><span class="o">=</span><span class="n">td_prepared</span><span class="p">,</span>
        <span class="n">split_csv</span><span class="o">=</span><span class="n">split_csv</span><span class="p">,</span>
        <span class="n">input_tile_width_meters</span><span class="o">=</span><span class="mi">110</span><span class="p">,</span>
        <span class="n">subtile_width_meters</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">data_prepper</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">td_prepared</span></div>


<span class="k">def</span> <span class="nf">_get_data_preparation_parser</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Gets a parser with parameters for dataset preparation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        argparse.ArgumentParser: the parser.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Prepare a Lidar dataset for deep learning.&quot;</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s2">&quot;If you need a toy dataset, you only need to&quot;</span>
        <span class="s2">&quot; set --origin=FR_TOY and specify a value for --prepared_data_dir.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--input_data_dir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./data/raw/&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to directory with las files with unique basename and `.las` suffix.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--split_csv&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./split.csv&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to csv with a basename (e.g. &#39;123_456.las&#39;) and split (train/val/test) columns specifying the dataset split.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--prepared_data_dir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./data/prepared/&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to folder to save Data object train/val/test subfolders.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--origin&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;FR&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;FR&quot;</span><span class="p">,</span> <span class="s2">&quot;CH&quot;</span><span class="p">,</span> <span class="s2">&quot;FR_TOY&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../apidoc/myria3d.data.html#myria3d.data.loading.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Code to execute to prepare a new set of Lidar tiles for training 3D segmentaiton neural networks.</span>

<span class="sd">    From a data directory containing point cloud in LAS format, and a scv specifying the dataset</span>
<span class="sd">    train/val/test split for each file (columns: split, basename, example: &quot;val&quot;,&quot;123_456.las&quot;),</span>
<span class="sd">    split the dataset, chunk the point cloud tiles into smaller subtiles, and prepare each sample</span>
<span class="sd">    as a pytorch geometric Data object.</span>

<span class="sd">    Echo numbers and colors are scaled to be in 0-1 range. Intensity and average color</span>
<span class="sd">    are not scaled b/c they are expected to be standardized later.</span>

<span class="sd">    To show help relative to data preparation, run:</span>

<span class="sd">        cd myria3d/datamodules/</span>

<span class="sd">        conda activate myria3d</span>

<span class="sd">        python loading.py -h</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">_get_data_preparation_parser</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;FR_TOY&quot;</span><span class="p">:</span>
        <span class="n">make_toy_dataset_from_test_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">prepared_data_dir</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;FR&quot;</span><span class="p">:</span>
        <span class="n">data_prepper</span> <span class="o">=</span> <span class="n">FrenchLidarDataLogic</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">data_prepper</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;CH&quot;</span><span class="p">:</span>
        <span class="n">data_prepper</span> <span class="o">=</span> <span class="n">SwissTopoLidarDataLogic</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">data_prepper</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data origin is invalid (currently: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">origin</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Institut National de l&#39;Information GÃ©ographique et ForestiÃ¨re.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>