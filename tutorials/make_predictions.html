<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Performing inference on new data &mdash; myria3d 2.4.2 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to train new models" href="../guides/train_new_model.html" />
    <link rel="prev" title="Preparing data for training" href="prepare_dataset.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> myria3d
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup_install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="setup_install.html#setting-up-a-virtual-environment">Setting up a virtual environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="setup_install.html#install-source-as-a-package">Install source as a package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="prepare_dataset.html">Preparing data for training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="prepare_dataset.html#peprocessing-functions">Peprocessing functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="prepare_dataset.html#using-your-own-data">Using your own data</a></li>
<li class="toctree-l2"><a class="reference internal" href="prepare_dataset.html#getting-started-quickly-with-a-toy-dataset">Getting started quickly with a toy dataset</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Performing inference on new data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#run-inference-from-installed-package">Run inference from installed package</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-inference-from-sources">Run inference from sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-inference-from-within-a-docker-image">Run inference from within a docker image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#specific-options">Specific options</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guides/train_new_model.html">How to train new models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../guides/train_new_model.html#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/train_new_model.html#quick-run">Quick run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/train_new_model.html#training">Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/train_new_model.html#testing-the-model">Testing the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/train_new_model.html#inference">Inference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../guides/development.html">Developer’s guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../guides/development.html#code-versionning">Code versionning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/development.html#tests">Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/development.html#continuous-integration-ci">Continuous Integration (CI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/development.html#continuous-delivery-cd">Continuous Delivery (CD)</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../background/interpolation.html">KNN-Interpolation to merge multiple predictions [TODO]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/general_design.html">General design of the package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../background/general_design.html#subsampling-is-important-to-improve-point-cloud-structure">Subsampling is important to improve point cloud structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../background/general_design.html#speed-is-of-the-essence">Speed is of the essence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../background/general_design.html#evaluation-is-key-to-select-the-right-approach">Evaluation is key to select the right approach</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../apidoc/scripts.html">Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/scripts.html#module-run">run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/scripts.html#module-myria3d.train">myria3d.train</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/scripts.html#module-myria3d.predict">myria3d.predict</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../apidoc/configs.html">Default configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apidoc/myria3d.pctl.html">myria3d.pctl</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.pctl.html#module-myria3d.pctl.datamodule">myria3d.pctl.datamodule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.pctl.html#module-myria3d.pctl.dataset">myria3d.pctl.dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.pctl.html#module-myria3d.pctl.dataloader">myria3d.pctl.dataloader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.pctl.html#module-myria3d.pctl.points_pre_transform">myria3d.pctl.points_pre_transform</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.pctl.html#module-myria3d.pctl.transforms">myria3d.pctl.transforms</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../apidoc/myria3d.model.html">myria3d.models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.model.html#module-myria3d.models.model">Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.model.html#module-myria3d.models.interpolation">Interpolation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../apidoc/myria3d.models.modules.html">myria3d.models.modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.models.modules.html#randla-net">RandLA-Net</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../apidoc/myria3d.callbacks.html">myria3d.callbacks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.callbacks.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.callbacks.html#module-myria3d.callbacks.comet_callbacks">myria3d.callbacks.comet_callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.callbacks.html#module-myria3d.callbacks.finetuning_callbacks">myria3d.callbacks.finetuning_callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.callbacks.html#module-myria3d.callbacks.logging_callbacks">myria3d.callbacks.logging_callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.callbacks.html#module-myria3d.callbacks">Module contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../apidoc/myria3d.utils.html">myria3d.utils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../apidoc/myria3d.utils.html#module-myria3d.utils.utils">myria3d.utils.utils</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">myria3d</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Performing inference on new data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/make_predictions.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="performing-inference-on-new-data">
<h1>Performing inference on new data<a class="headerlink" href="#performing-inference-on-new-data" title="Permalink to this headline"></a></h1>
<p>Refer to <a class="reference internal" href="setup_install.html"><span class="doc std std-doc">this tutorial</span></a> for how to setup a virtual environment and install the library.</p>
<p>To run inference, you will need:</p>
<ul class="simple">
<li><p>A source cloud point in LAS format on which to infer classes and probabilites. Sample data from the French “Lidar HD” project can be downloaded at <a class="reference external" href="https://geoservices.ign.fr/lidarhd">this address</a>.</p></li>
<li><p>A checkpoint of a trained lightning module implementing model logic (class <code class="docutils literal notranslate"><span class="pre">myria3d.models.model.Model</span></code>)</p></li>
<li><p>A minimal yaml configuration specifying parameters. We use <a class="reference external" href="https://hydra.cc/">hydra</a> to manage configurations, and this yaml results from the model training. The <code class="docutils literal notranslate"><span class="pre">datamodule</span></code> and <code class="docutils literal notranslate"><span class="pre">model</span></code> parameters groups must match dataset characteristics and model training settings.  The <code class="docutils literal notranslate"><span class="pre">predict</span></code> parameters group specifies path to models and data as well as batch size (N=50 works well, the larger the faster) and use of gpu (optionnal). For hints on what to modify, see the <code class="docutils literal notranslate"><span class="pre">experiment/predict.yaml</span></code> file.</p></li>
</ul>
<section id="run-inference-from-installed-package">
<h2>Run inference from installed package<a class="headerlink" href="#run-inference-from-installed-package" title="Permalink to this headline"></a></h2>
<p>From the package root, run <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-e</span> <span class="pre">.</span></code> to install the package locally and freeze its current version.</p>
<p>Then, fill out the {missing parameters} below and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -m myria3d.predict <span class="se">\</span>
--config-path <span class="o">{</span>/path/to/.hydra<span class="o">}</span> <span class="se">\</span>
--config-name <span class="o">{</span>config.yaml<span class="o">}</span> <span class="se">\</span>
predict.src_las<span class="o">={</span>/path/to/cloud.las<span class="o">}</span> <span class="se">\</span>
predict.output_dir<span class="o">={</span>/path/to/out/dir/<span class="o">}</span> <span class="se">\</span>
predict.ckpt_path<span class="o">={</span>/path/to/checkpoint.ckpt<span class="o">}</span> <span class="se">\</span>
predict.gpus<span class="o">={</span><span class="m">0</span> <span class="k">for</span> none, <span class="o">[</span>i<span class="o">]</span> to use GPU number i<span class="o">}</span> <span class="se">\</span>
datamodule.batch_size<span class="o">={</span>N<span class="o">}</span> <span class="se">\</span>
hydra.run.dir<span class="o">={</span>path/for/hydra/logs<span class="o">}</span>
</pre></div>
</div>
<p>To show you current inference config, simply add a <code class="docutils literal notranslate"><span class="pre">--help</span></code> flag:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -m myria3d.predict --config-path <span class="o">{</span>/path/to/.hydra<span class="o">}</span> --config-name <span class="o">{</span>config.yaml<span class="o">}</span> --help
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">predict.src_las</span></code> may be any valid glob pattern (e.g. <code class="docutils literal notranslate"><span class="pre">/path/to/multiple_files/*.las</span></code>), in order to <strong>predict on multiple files successively</strong>.</p>
</section>
<section id="run-inference-from-sources">
<h2>Run inference from sources<a class="headerlink" href="#run-inference-from-sources" title="Permalink to this headline"></a></h2>
<p>From the line for package-based inference above, simply change <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">myria3d.predict</span></code> to <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">run.py</span></code> to run directly from sources.</p>
<p>In case you want to swicth to package-based inference, you will need to comment out the parameters that depends on local environment variables such as logger credentials and training data directory. You can do so by making a copy of your configuration file and commenting out the lines containing <code class="docutils literal notranslate"><span class="pre">oc.env</span></code> logic.</p>
</section>
<section id="run-inference-from-within-a-docker-image">
<h2>Run inference from within a docker image<a class="headerlink" href="#run-inference-from-within-a-docker-image" title="Permalink to this headline"></a></h2>
<p>Up to date docker images (named <code class="docutils literal notranslate"><span class="pre">myria3d</span></code>) are created via Github integration actions (see <a class="reference internal" href="../guides/development.html"><span class="doc std std-doc">Developer’s guide</span></a>.</p>
<p>A docker image encapsulating the virtual environment and application sources can also be built using the provided Dockerfile. At built time, the Dockerfile is not standalone and should be part of the repository - whose content is copied into the image - at the github reference you want to build from.</p>
<p>To run inference:</p>
<ul class="simple">
<li><p>Mount the needed volumes with the <code class="docutils literal notranslate"><span class="pre">-v</span></code> option.</p></li>
<li><p>Always set <code class="docutils literal notranslate"><span class="pre">--ipc=host</span></code> to allow multithreading in pytorch dataloader (as mentionned in <a class="reference external" href="https://github.com/pytorch/pytorch#using-pre-built-images">Pytorch’s README</a>).</p></li>
<li><p>Increase the shared memory with <code class="docutils literal notranslate"><span class="pre">--shm-size=2gb</span></code> (which should be enough for 1km*1km point French “Lidar HD” clouds).</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># specify your paths here as needed</span>
docker run -v <span class="o">{</span>local_inputs<span class="o">}</span>:/inputs/ -v <span class="o">{</span>local_output<span class="o">}</span>:/outputs/ --ipc<span class="o">=</span>host --shm-size<span class="o">=</span>2gb myria3d.predict <span class="o">{</span>...options...<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="specific-options">
<h2>Specific options<a class="headerlink" href="#specific-options" title="Permalink to this headline"></a></h2>
<section id="output-format">
<h3>Output format<a class="headerlink" href="#output-format" title="Permalink to this headline"></a></h3>
<p>By default, the predicted classification is stored in a new PRedictedClassification format, which is not a config parameter at the moment. The probability <a class="reference external" href="https://en.wikipedia.org/wiki/Entropy_(information_theory)">entropy</a> is also stored, as a proxy for prediction uncertainty.</p>
<p>What one can control is for which classes to save the probabilities. This is achieved with a <code class="docutils literal notranslate"><span class="pre">predict.probas_to_save</span></code> config parameter, which can be either the <code class="docutils literal notranslate"><span class="pre">all</span></code> keyword (to save probabilities for all classes) or a list of specific classes (e.g. <code class="docutils literal notranslate"><span class="pre">predict.probas_to_save=[building,vegetation]</span></code> - notice the absence of space between class names).</p>
</section>
<section id="receptive-field-overlap-at-inference-time">
<h3>Receptive field overlap at inference time<a class="headerlink" href="#receptive-field-overlap-at-inference-time" title="Permalink to this headline"></a></h3>
<p>To improve spatial regularity of the predicted probabilities, one can make inference on square receptive fields that have a non-null overlap with each other. This has the effect of smoothing out irregular predictions. The resulting classification is better looking, with more homogeneous predictions at the object level.</p>
<p>To define an overlap between successive 50m*50m receptive fields, set <code class="docutils literal notranslate"><span class="pre">predict.subtile_overlap={value}</span></code>.
This, however, comes with a large computation price. For instance, <code class="docutils literal notranslate"><span class="pre">predict.subtile_overlap=25</span></code> means a 25m overlap on both x and y axes, which multiplies inference time by a factor of 4.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="prepare_dataset.html" class="btn btn-neutral float-left" title="Preparing data for training" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../guides/train_new_model.html" class="btn btn-neutral float-right" title="How to train new models" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Institut National de l&#39;Information Géographique et Forestière.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>